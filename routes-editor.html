<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Routes Editor (Search-first)</title>
  <style>
    * { box-sizing:border-box; font-family: Arial, sans-serif; }
    body { margin:0; padding:18px; background:#f5f5f5; color:#222; }
    .wrap { max-width: 1300px; margin:0 auto; background:#fff; padding:16px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    h1 { margin:0 0 12px; font-size:22px; display:flex; align-items:center; gap:10px; }
    .pill { display:inline-block; font-size:11px; padding:3px 8px; border-radius:999px; background:#f0f0f0; border:1px solid #e0e0e0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; margin: 10px 0; }
    .group { background:#fafafa; border:1px solid #e6e6e6; border-radius:10px; padding:12px; }
    label { font-size:12px; font-weight:bold; display:block; margin-bottom:4px; }
    input[type="text"], select {
      padding:8px 10px; border:1px solid #ccc; border-radius:6px; font-size:13px; width: 220px;
    }
    .small { width:150px !important; }
    .wide { width:320px !important; }
    button {
      padding:9px 12px; border:0; border-radius:6px; background:#0078d4; color:#fff; cursor:pointer; font-size:13px;
    }
    button:hover { background:#005ea3; }
    button:disabled { background:#9bbbd7; cursor:not-allowed; }
    .mini-btn { background:#444 !important; padding:7px 10px !important; }
    .mini-btn:hover { background:#333 !important; }
    .muted { font-size:12px; color:#666; }
    .status { font-size:12px; padding:8px 10px; border-radius:6px; background:#f0f7ff; border:1px solid #d6eaff; }
    .status.bad { background:#ffecec; border-color:#ffd0d0; color:#900; }
    .toolbar-right { margin-left:auto; display:flex; gap:10px; align-items:center; }

    table { width:100%; border-collapse:collapse; margin-top:10px; table-layout: fixed; background:#fff; }
    th, td { border:1px solid #e2e2e2; padding:7px 8px; font-size:13px; text-align:left; vertical-align:top; }
    th { background:#f2f2f2; position:sticky; top:0; z-index:1; }
    .col-check { width:44px; text-align:center; }
    .col-prefix { width:100px; }
    .col-channel { width:190px; }
    .col-route { width:280px; }
    .col-service { width:140px; }
    .col-lead { width:120px; }
    .col-days { width:220px; }

    .pager { display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap; }
    .pager .box { background:#fafafa; border:1px solid #e6e6e6; border-radius:10px; padding:10px; }
    .pager .num { font-weight:700; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Routes Editor <span class="pill">Search-first (fast)</span></h1>

    <div class="row">
      <div class="status" id="statusBox">Loading metaâ€¦</div>
      <div class="toolbar-right">
        <button id="reloadMetaBtn">Reload meta</button>
        <button id="saveSelectedBtn" disabled>Save selected edits</button>
      </div>
    </div>

    <div class="group">
      <div class="row">
        <div style="min-width:260px;">
          <div class="muted"><strong>How it works</strong></div>
          <div class="muted">No rows are loaded until you search. Bulk updates run server-side (no 11k table).</div>
        </div>

        <div>
          <label>Channel</label>
          <select id="filterChannel" class="wide">
            <option value="ALL">ALL</option>
          </select>
        </div>

        <div>
          <label>Prefix contains</label>
          <input id="filterPrefix" type="text" placeholder="e.g. AB1" class="small"/>
        </div>

        <div>
          <label>Route contains</label>
          <input id="filterRoute" type="text" placeholder="e.g. TKC01" class="wide"/>
        </div>

        <div>
          <label>Page size</label>
          <select id="pageSize">
            <option>200</option>
            <option selected>500</option>
            <option>1000</option>
            <option>2000</option>
          </select>
        </div>

        <div>
          <button id="searchBtn">Search</button>
        </div>
      </div>

      <div class="row" style="align-items:flex-end;">
        <div>
          <label>Prefix range (optional)</label>
          <div class="muted">Use for range searches or range bulk update.</div>
        </div>
        <div>
          <label>From</label>
          <input id="rangeFrom" type="text" class="small" placeholder="e.g. AB10 or AB"/>
        </div>
        <div>
          <label>To</label>
          <input id="rangeTo" type="text" class="small" placeholder="e.g. AB14 or AC"/>
        </div>
        <div class="muted">Leave blank to ignore range.</div>
      </div>
    </div>

    <div class="group" style="margin-top:12px;">
      <div class="row" style="align-items:flex-end;">
        <div style="min-width:240px;">
          <div class="muted"><strong>Bulk update (server-side)</strong></div>
          <div class="muted">Applies without loading every matching row.</div>
        </div>

        <div>
          <label>Bulk mode</label>
          <select id="bulkMode">
            <option value="filtered">Filtered results (entire match)</option>
            <option value="range">Prefix range (entire match)</option>
            <option value="selected">Ticked rows (this page)</option>
          </select>
        </div>

        <div>
          <label>Assign Route</label>
          <select id="bulkRoute" class="wide">
            <option value="">(no change)</option>
          </select>
        </div>

        <div>
          <label>Delivery Type</label>
          <select id="bulkServiceType">
            <option value="">(no change)</option>
            <option>One-person</option>
            <option>Two-person</option>
          </select>
        </div>

        <div>
          <label>Lead Time</label>
          <input id="bulkLeadTime" type="text" class="small" placeholder="e.g. 5 Days"/>
        </div>

        <div>
          <button id="runBulkBtn">Run bulk update</button>
        </div>

        <div class="muted" style="flex-basis:100%;">
          Delivery days remain route-defined and are updated automatically by the API.
        </div>
      </div>
    </div>

    <div style="margin-top:12px; overflow:auto; border-radius:10px; border:1px solid #e6e6e6;">
      <table>
        <thead>
          <tr>
            <th class="col-check"><input id="masterCheck" type="checkbox" title="Tick/untick visible rows"/></th>
            <th class="col-prefix">Prefix</th>
            <th class="col-channel">Channel</th>
            <th class="col-route">Route</th>
            <th class="col-service">Delivery Type</th>
            <th class="col-lead">Lead Time</th>
            <th class="col-days">Days</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="7" class="muted" style="padding:12px;">Search to load rows.</td></tr>
        </tbody>
      </table>
    </div>

    <div class="pager" id="pager" style="display:none;">
      <div class="box">
        Results: <span class="num" id="totalCount">0</span>
      </div>
      <button class="mini-btn" id="prevBtn">Prev</button>
      <button class="mini-btn" id="nextBtn">Next</button>
      <div class="box">
        Page offset: <span class="num" id="offsetTxt">0</span>
      </div>
    </div>

    <div class="muted" style="margin-top:10px;">
      Prefix + Channel are locked. Days are route-defined. No add/delete rows.
    </div>
  </div>

  <script>
    const API_BASE = "https://script.google.com/macros/s/AKfycby2UaJDmzrkxCm27BA4rH3Fo5xHaHk9lWENv7NvxJWHa0L-P2T_SVJPkMagdNX3QDNvLw/exec";

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const script = document.createElement("script");
        const sep = url.includes("?") ? "&" : "?";
        const full = url + sep + "callback=" + encodeURIComponent(cbName);

        window[cbName] = (data) => { cleanup(); resolve(data); };
        script.onerror = () => { cleanup(); reject(new Error("Network error (JSONP)")); };

        function cleanup() { delete window[cbName]; script.remove(); }
        script.src = full;
        document.body.appendChild(script);
      });
    }

    const statusBox = document.getElementById("statusBox");
    function setStatus(msg, bad=false){
      statusBox.textContent = msg;
      statusBox.classList.toggle("bad", !!bad);
    }

    // Meta
    let channels = [];
    let routeMeta = {};
    let metaVersion = "";

    // Current page data
    let rows = [];
    let total = 0;
    let offset = 0;

    // Edits on current page only (selected save)
    const dirty = new Map(); // key prefix||channel -> {prefix,channel,route,serviceType,leadTime}

    const filterChannel = document.getElementById("filterChannel");
    const filterPrefix = document.getElementById("filterPrefix");
    const filterRoute = document.getElementById("filterRoute");
    const rangeFrom = document.getElementById("rangeFrom");
    const rangeTo = document.getElementById("rangeTo");
    const pageSize = document.getElementById("pageSize");

    const tbody = document.getElementById("tbody");
    const pager = document.getElementById("pager");
    const totalCount = document.getElementById("totalCount");
    const offsetTxt = document.getElementById("offsetTxt");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

    const saveSelectedBtn = document.getElementById("saveSelectedBtn");

    const bulkMode = document.getElementById("bulkMode");
    const bulkRoute = document.getElementById("bulkRoute");
    const bulkServiceType = document.getElementById("bulkServiceType");
    const bulkLeadTime = document.getElementById("bulkLeadTime");

    const masterCheck = document.getElementById("masterCheck");

    function markDirty(){
      saveSelectedBtn.disabled = (dirty.size === 0);
    }

    function rebuildRouteDropdown(){
      bulkRoute.innerHTML = "";
      bulkRoute.appendChild(new Option("(no change)", ""));
      Object.keys(routeMeta).sort((a,b)=>a.localeCompare(b)).forEach(r => {
        bulkRoute.appendChild(new Option(r, r));
      });
    }

    async function loadMeta(){
      setStatus("Loading meta (channels/routes)...");
      const res = await jsonp(`${API_BASE}?action=meta&cb=${Date.now()}`);
      if (!res || !res.ok) throw new Error(res && res.error ? res.error : "Meta load failed");

      channels = res.channels || [];
      routeMeta = res.routeMeta || {};
      metaVersion = res.version || "";

      filterChannel.innerHTML = `<option value="ALL">ALL</option>`;
      channels.forEach(ch => filterChannel.appendChild(new Option(ch, ch)));

      rebuildRouteDropdown();
      setStatus("Meta loaded. Enter filters and click Search.");
    }

    function currentSearchParams(){
      return {
        channel: filterChannel.value || "ALL",
        prefixContains: filterPrefix.value.trim(),
        routeContains: filterRoute.value.trim(),
        rangeFrom: rangeFrom.value.trim(),
        rangeTo: rangeTo.value.trim(),
        limit: parseInt(pageSize.value, 10) || 500
      };
    }

    async function runSearch(newOffset=0){
      const p = currentSearchParams();
      offset = Math.max(0, newOffset);

      // Require at least one filter (prevents accidental full-table pulls)
      const hasAny =
        (p.channel && p.channel !== "ALL") ||
        !!p.prefixContains ||
        !!p.routeContains ||
        (!!p.rangeFrom && !!p.rangeTo);

      if (!hasAny) {
        alert("Enter at least one filter (Channel / Prefix / Route / Range) before searching.");
        return;
      }

      setStatus("Searching...");
      dirty.clear();
      markDirty();
      masterCheck.checked = false;

      const qs = new URLSearchParams({
        action: "search",
        channel: p.channel,
        prefixContains: p.prefixContains,
        routeContains: p.routeContains,
        rangeFrom: p.rangeFrom,
        rangeTo: p.rangeTo,
        offset: String(offset),
        limit: String(p.limit),
        cb: String(Date.now())
      });

      const res = await jsonp(`${API_BASE}?${qs.toString()}`);
      if (!res || !res.ok) throw new Error(res && res.error ? res.error : "Search failed");

      rows = res.rows || [];
      total = res.total || 0;

      renderTable();
      renderPager();
      setStatus(`Loaded ${rows.length.toLocaleString()} rows (page) from ${total.toLocaleString()} matches.`);
    }

    function renderPager(){
      pager.style.display = "flex";
      totalCount.textContent = total.toLocaleString();
      offsetTxt.textContent = offset.toLocaleString();

      const limit = parseInt(pageSize.value, 10) || 500;

      prevBtn.disabled = (offset <= 0);
      nextBtn.disabled = (offset + limit >= total);
    }

    function renderTable(){
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="muted" style="padding:12px;">No results.</td></tr>`;
        return;
      }

      rows.forEach((r, i) => {
        const tr = document.createElement("tr");

        const tdC = document.createElement("td");
        tdC.className = "col-check";
        tdC.innerHTML = `<input type="checkbox" class="rowCheck" data-i="${i}">`;
        tr.appendChild(tdC);

        tr.appendChild(textCell(r.prefix, "col-prefix"));
        tr.appendChild(textCell(r.channel, "col-channel"));

        tr.appendChild(routeCell(i, r));
        tr.appendChild(serviceCell(i, r));
        tr.appendChild(leadCell(i, r));

        tr.appendChild(textCell(r.days, "col-days"));

        tbody.appendChild(tr);
      });
    }

    function textCell(text, cls){
      const td = document.createElement("td");
      td.className = cls;
      td.textContent = text ?? "";
      return td;
    }

    function routeCell(i, r){
      const td = document.createElement("td");
      td.className = "col-route";
      const sel = document.createElement("select");
      sel.style.width = "100%";
      sel.appendChild(new Option("(select route)", ""));
      Object.keys(routeMeta).sort((a,b)=>a.localeCompare(b)).forEach(rt => sel.appendChild(new Option(rt, rt)));
      sel.value = r.route || "";

      sel.addEventListener("change", () => {
        r.route = sel.value;
        // update displayed days immediately from meta if possible
        if (r.route && routeMeta[r.route] && routeMeta[r.route].days) r.days = routeMeta[r.route].days;
        dirty.set(`${r.prefix}||${r.channel}`, pickUpdatable(r));
        markDirty();
        renderTable(); // refresh days column
      });

      td.appendChild(sel);
      return td;
    }

    function serviceCell(i, r){
      const td = document.createElement("td");
      td.className = "col-service";
      const sel = document.createElement("select");
      sel.style.width = "100%";
      ["","One-person","Two-person"].forEach(v => sel.appendChild(new Option(v || "(blank)", v)));
      sel.value = r.serviceType || "";
      sel.addEventListener("change", () => {
        r.serviceType = sel.value;
        dirty.set(`${r.prefix}||${r.channel}`, pickUpdatable(r));
        markDirty();
      });
      td.appendChild(sel);
      return td;
    }

    function leadCell(i, r){
      const td = document.createElement("td");
      td.className = "col-lead";
      const inp = document.createElement("input");
      inp.type = "text";
      inp.value = r.leadTime || "";
      inp.style.width = "100%";
      inp.addEventListener("blur", () => {
        r.leadTime = inp.value.trim();
        dirty.set(`${r.prefix}||${r.channel}`, pickUpdatable(r));
        markDirty();
      });
      td.appendChild(inp);
      return td;
    }

    function pickUpdatable(r){
      return { prefix: r.prefix, channel: r.channel, route: r.route, serviceType: r.serviceType, leadTime: r.leadTime };
    }

    async function saveSelectedEdits(){
      if (!dirty.size) return;
      setStatus("Saving selected edits...");
      saveSelectedBtn.disabled = true;

      const payload = encodeURIComponent(JSON.stringify({ rowUpdates: Array.from(dirty.values()) }));
      const res = await jsonp(`${API_BASE}?action=save&payload=${payload}&cb=${Date.now()}`);

      if (!res || !res.ok) {
        setStatus(res && res.error ? res.error : "Save failed", true);
        saveSelectedBtn.disabled = false;
        return;
      }

      dirty.clear();
      markDirty();
      setStatus(`Saved. Updated rows: ${res.updatedRows || 0}. Corrected day cells: ${res.correctedDays || 0}.`);

      // refresh current page
      await runSearch(offset);
    }

    async function runBulk(){
      const mode = bulkMode.value;
      const updates = {};
      if (bulkRoute.value) updates.route = bulkRoute.value;
      if (bulkServiceType.value) updates.serviceType = bulkServiceType.value;
      if (bulkLeadTime.value.trim()) updates.leadTime = bulkLeadTime.value.trim();

      if (!("route" in updates) && !("serviceType" in updates) && !("leadTime" in updates)) {
        alert("Enter at least one bulk change field.");
        return;
      }

      const p = currentSearchParams();

      // Build payload by mode
      const payload = { mode, channel: p.channel, prefixContains: p.prefixContains, routeContains: p.routeContains, updates };

      if (mode === "range") {
        if (!p.rangeFrom || !p.rangeTo) { alert("Enter From + To for range mode."); return; }
        payload.rangeFrom = p.rangeFrom;
        payload.rangeTo = p.rangeTo;
      }

      if (mode === "selected") {
        const checked = Array.from(document.querySelectorAll(".rowCheck:checked"))
          .map(cb => rows[Number(cb.dataset.i)])
          .filter(Boolean)
          .map(r => ({ prefix: r.prefix, channel: r.channel }));

        if (!checked.length) { alert("Tick at least one row on this page."); return; }
        payload.keys = checked;
      }

      if (!confirm("Run bulk update now? This will update the Sheet directly.")) return;

      setStatus("Running bulk update...");
      const encoded = encodeURIComponent(JSON.stringify(payload));
      const res = await jsonp(`${API_BASE}?action=bulkUpdate&payload=${encoded}&cb=${Date.now()}`);

      if (!res || !res.ok) {
        setStatus(res && res.error ? res.error : "Bulk update failed", true);
        return;
      }

      setStatus(`Bulk complete. Applied rows: ${res.appliedRows || 0}. Corrected day cells: ${res.correctedDays || 0}.`);
      await runSearch(0);
    }

    // Events
    document.getElementById("searchBtn").addEventListener("click", () => runSearch(0));
    prevBtn.addEventListener("click", () => {
      const limit = parseInt(pageSize.value, 10) || 500;
      runSearch(Math.max(0, offset - limit));
    });
    nextBtn.addEventListener("click", () => {
      const limit = parseInt(pageSize.value, 10) || 500;
      runSearch(offset + limit);
    });

    document.getElementById("reloadMetaBtn").addEventListener("click", async () => {
      try { await loadMeta(); }
      catch (e) { console.error(e); setStatus(String(e.message||e), true); }
    });

    saveSelectedBtn.addEventListener("click", saveSelectedEdits);
    document.getElementById("runBulkBtn").addEventListener("click", runBulk);

    masterCheck.addEventListener("change", () => {
      document.querySelectorAll(".rowCheck").forEach(cb => cb.checked = masterCheck.checked);
    });

    // Init
    (async function init(){
      try { await loadMeta(); }
      catch (e) { console.error(e); setStatus("Failed to load meta. Check API_BASE and deployment.", true); }
    })();
  </script>
</body>
</html>
